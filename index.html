<!DOCTYPE html>
<html lang="zh-TW"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>å—å±±å‡æ—¥éŠ·éå ±åç³»çµ±</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet"/>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
<style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .card {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .form-label {
            font-weight: 500;
        }
        #previewContent, #queryResults {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
        }
        .header {
            background-color: #343a40;
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
            border-radius: 5px;
        }
        .footer {
            margin-top: 30px;
            padding: 15px 0;
            text-align: center;
            color: #6c757d;
        }
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: middle;
            border: 0.15em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border .75s linear infinite;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }
        .admin-section {
            margin-top: 30px;
            border-top: 1px solid #dee2e6;
            padding-top: 20px;
        }
        .error-details {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 10px;
        }
        
        /* ä¿®æ­£åˆ—å°æ¨£å¼ - åªä¿ç•™åå–®åˆ—å°åŠŸèƒ½ */
        @media print {
            body * {
                visibility: hidden;
                margin: 0;
                padding: 0;
            }
            body.print-list #printListContent {
                visibility: visible;
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                background: white;
                margin: 0;
                padding: 15px;
            }
            body.print-list #printListContent * {
                visibility: visible;
            }
            .no-print {
                display: none !important;
            }
            /* ç¢ºä¿è¡¨æ ¼æœ‰è¶³å¤ ç©ºé–“ */
            table {
                width: 100%;
                border-collapse: collapse;
                margin-bottom: 15px;
            }
            th, td {
                padding: 8px;
                border: 1px solid #ddd;
            }
            /* èª¿æ•´æ¨™é¡Œé–“è· */
            h2, h4 {
                margin-top: 10px;
                margin-bottom: 15px;
                page-break-after: avoid;
            }
            /* é˜²æ­¢åˆ†é æ™‚åˆ‡æ–·è¡¨æ ¼ */
            table {
                page-break-inside: auto;
            }
            tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
        }
    </style>
</head>
<body>
<div class="container">

<ul class="nav nav-tabs mb-4 sticky-top bg-white pt-3" id="mainTabs">
<li class="nav-item">
<button class="nav-link active" data-target="#tabStudent">å ±åè¡¨å–®</button>
</li>
<li class="nav-item">
<button class="nav-link" data-target="#tabAdmin" onclick="showLoginModal(); return false;">ç®¡ç†å“¡</button>
</li>

<li class="nav-item ms-auto" id="logoutTab" style="display: none;">
<button class="nav-link text-danger" onclick="logout()">ç™»å‡º</button>
</li>
</ul>
<div class="header text-center">
<h1>å—å±±å‡æ—¥éŠ·éå ±åç³»çµ±</h1>
</div>
<div class="tab-main" id="tabStudent"><div class="card mb-4">
<div class="card-header bg-primary text-white">
<h5 class="mb-0">å ±åè¡¨å–®</h5>
</div>
<div class="card-body">
<form id="registrationForm">
<div class="row mb-3">
<div class="col-md-6">
<label class="form-label" for="studentId">å­¸è™Ÿ</label>
<input class="form-control" id="studentId" placeholder="è«‹è¼¸å…¥å­¸è™Ÿ" required="" type="text"/>
<div class="mt-2" id="studentInfo"></div>
</div>
</div>
<div class="row mb-3">
<div class="col-md-6">
<label class="form-label" for="activityDate">å¯¦æ–½æ—¥æœŸ</label>
<select class="form-select" id="activityDate" required="">
<option value="">è«‹é¸æ“‡æ—¥æœŸ</option>
</select>
<div class="mt-2 text-muted" id="dateInfo"></div>
</div>
<div class="col-md-6">
<label class="form-label" for="activityHours">å¯¦æ–½æ™‚æ•¸</label>
<select class="form-select" id="activityHours" required="">
<option value="">è«‹é¸æ“‡æ™‚æ•¸</option>
<option value="2">2å°æ™‚</option>
<option value="4">4å°æ™‚</option>
</select>
</div>
</div>
<div class="row mb-4">
<div class="col-md-6">
<label class="form-label" for="activityType">é¡åˆ¥</label>
<select class="form-select" id="activityType" required="">
<option value="">è«‹é¸æ“‡é¡åˆ¥</option>
<option value="éŠ·é">éŠ·é</option>
<option value="å‡æ—¥ç”Ÿæ´»è¼”å°">å‡æ—¥ç”Ÿæ´»è¼”å°</option>
</select>
</div>
</div>
<div class="d-grid gap-2 d-md-flex justify-content-md-end">
<button class="btn btn-primary me-md-2" id="previewBtn" type="button">
<i class="bi bi-eye-fill"></i> é è¦½
                        </button>
<button class="btn btn-secondary" type="reset">æ¸…é™¤</button>
</div>
</form>
</div>
</div><div class="card" id="previewSection" style="display: none;">
<div class="card-header bg-success text-white">
<h5 class="mb-0">å ±åé è¦½</h5>
</div>
<div class="card-body">
<div id="previewContent"></div>
<div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
<button class="btn btn-success me-md-2" id="confirmBtn" type="button">
<i class="bi bi-check-circle-fill"></i> ç¢ºèªæäº¤
                    </button>
<button class="btn btn-warning me-md-2" id="editBtn" type="button">
<i class="bi bi-pencil-fill"></i> ä¿®æ”¹è³‡æ–™
                    </button>
</div>
</div>
</div></div>

<!-- ç®¡ç†å“¡æŸ¥è©¢å€å¡Š -->

<!-- éš±è—çš„åˆ—å°åå–®å…§å®¹ -->
<div id="printListContent" style="display: none;">
<div class="text-center mb-4">
<h2>å—å±±ä¸­å­¸å‡æ—¥éŠ·éå ±ååå–®</h2>
<h4 id="printListDate"></h4>
<p class="text-muted">åˆ—å°æ™‚é–“: <span id="printListTime"></span></p>
</div>
<table class="table table-bordered" id="printListTable">
<thead class="table-dark">
<tr>
<th>åºè™Ÿ</th>
<th>å­¸è™Ÿ</th>
<th>å§“å</th>
<th>ç­ç´š</th>
<th>æ™‚æ•¸</th>
<th>é¡åˆ¥</th>
<th>å ±åæ™‚é–“</th>
</tr>
</thead>
<tbody id="printListBody"></tbody>
</table>
<div class="text-end mt-4">
<p>ç¸½äººæ•¸: <span id="printTotalCount">0</span>äºº</p>
</div>
</div>
<div class="footer">
<p>å—å±±ä¸­å­¸ æ ¡å®‰ä¸­å¿ƒ Â© 2025</p>
</div>
<div class="tab-main" id="tabAdmin" style="display: none;">
<div class="card mb-4">
<div class="card-header bg-info text-white">
<h5 class="mb-0">ç®¡ç†å¯¦æ–½æ—¥æœŸ</h5>
</div>
<div class="card-body">
<div class="input-group mb-3">
<input class="form-control" id="newDateInput" type="date"/>
<button class="btn btn-success" id="addDateBtn">
<i class="bi bi-plus-circle"></i> æ–°å¢æ—¥æœŸ
            </button>
</div>
<ul class="list-group" id="dateList"></ul>
</div>
</div>
<div class="admin-section">
<div class="card mb-4">
<div class="card-header bg-secondary text-white">
<h5 class="mb-0">ç®¡ç†å“¡æŸ¥è©¢</h5>
</div>
<div class="card-body">
<div class="row mb-3">
<div class="col-md-4">
<label class="form-label" for="queryStudentId">å­¸è™Ÿ</label>
<input class="form-control" id="queryStudentId" placeholder="å¯é¸å¡«å­¸è™Ÿ" type="text"/>
</div>
<div class="col-md-4">
<label class="form-label" for="queryDate">æŸ¥è©¢æ—¥æœŸ</label>
<select class="form-select" id="queryDate">
<option value="">è«‹é¸æ“‡æŸ¥è©¢æ—¥æœŸ</option>
</select>
</div>
<div class="col-md-4 d-flex align-items-end">
<button class="btn btn-primary" id="queryBtn" type="button">
<i class="bi bi-search"></i> æŸ¥è©¢
                            </button>
<button class="btn btn-success ms-2" id="printListBtn" style="display: none;" type="button">
<i class="bi bi-printer-fill"></i> åˆ—å°åå–®
                            </button>
</div>
</div>
<div id="queryResults"></div>
</div>
</div>
</div></div></div>
<script>
        // åˆå§‹åŒ– Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAMlgRs8a0-eZSamx1-EF3y2obIAOLvaZI",
            authDomain: "nanshan-student.firebaseapp.com",
            databaseURL: "https://nanshan-student-default-rtdb.firebascio.com",
            projectId: "nanshan-student",
            storageBucket: "nanshan-student.firebasestorage.app",
            messagingSenderId: "879754099667",
            appId: "1:879754099667:web:0c08805c2d918b8b41e4d26",
            measurementId: "G-KTX7TH9ETW"
        };

        // åˆå§‹åŒ– Firebase
        let db;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            // æ¸¬è©¦é€£ç·š
            db.collection('æ¸¬è©¦é€£ç·š').doc('test').get()
                .catch(error => {
                    console.error("Firestore é€£ç·šæ¸¬è©¦å¤±æ•—:", error);
                    showConnectionError();
                });
        } catch (error) {
            console.error("Firebase åˆå§‹åŒ–éŒ¯èª¤:", error);
            showConnectionError();
        }

        function showConnectionError() {
            const errorAlert = document.createElement('div');
            errorAlert.className = 'alert alert-danger';
            errorAlert.innerHTML = `
                <strong>è³‡æ–™åº«é€£ç·šéŒ¯èª¤</strong> 
                <div class="error-details">ç„¡æ³•é€£æ¥åˆ°è³‡æ–™åº«æœå‹™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ–è¯ç¹«ç®¡ç†å“¡ã€‚</div>
            `;
            document.querySelector('.container').prepend(errorAlert);
        }

        // å®šç¾©å¯å ±åçš„æ—¥æœŸ
        const availableDates = [
            
            '2025-05-04',
            '2025-05-18',
            '2025-05-25',
            '2025-06-08',
            '2025-06-15',
        ];

        // DOM å…ƒç´ 
        const elements = {
            studentIdInput: document.getElementById('studentId'),
            studentInfoDiv: document.getElementById('studentInfo'),
            activityDateSelect: document.getElementById('activityDate'),
            dateInfoDiv: document.getElementById('dateInfo'),
            previewSection: document.getElementById('previewSection'),
            previewContent: document.getElementById('previewContent'),
            previewBtn: document.getElementById('previewBtn'),
            confirmBtn: document.getElementById('confirmBtn'),
            editBtn: document.getElementById('editBtn'),
            queryStudentId: document.getElementById('queryStudentId'),
            queryDate: document.getElementById('queryDate'),
            queryBtn: document.getElementById('queryBtn'),
            queryResults: document.getElementById('queryResults'),
            printListBtn: document.getElementById('printListBtn'),
            printListContent: document.getElementById('printListContent'),
            printListDate: document.getElementById('printListDate'),
            printListTime: document.getElementById('printListTime'),
            printListBody: document.getElementById('printListBody'),
            printTotalCount: document.getElementById('printTotalCount')
        };

        // ç•¶å‰å­¸ç”Ÿè³‡æ–™å’ŒæŸ¥è©¢çµæœ
        let currentStudent = null;
        let registrationData = null;
        let queryResultData = [];

        // åˆå§‹åŒ–æ—¥æœŸé¸é …
        function initDateOptions() {
            elements.activityDateSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ—¥æœŸ</option>';
            elements.queryDate.innerHTML = '<option value="">è«‹é¸æ“‡æŸ¥è©¢æ—¥æœŸ</option>';
            
            availableDates.forEach(date => {
                const option1 = document.createElement('option');
                option1.value = date;
                option1.textContent = date;
                elements.activityDateSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = date;
                option2.textContent = date;
                elements.queryDate.appendChild(option2);
            });
        }
        // ğŸ”§ ç®¡ç†å“¡åŠŸèƒ½ï¼šå¢åˆªå¯¦æ–½æ—¥æœŸåŠŸèƒ½ç¨‹å¼ç¢¼
function renderDateManagement() {
    const adminSection = document.querySelector('.admin-section');
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">ç®¡ç†å¯¦æ–½æ—¥æœŸ</h5>
        </div>
        <div class="card-body">
            <div class="input-group mb-3">
                <input type="date" class="form-control" id="newDateInput">
                <button class="btn btn-success" id="addDateBtn">
                    <i class="bi bi-plus-circle"></i> æ–°å¢æ—¥æœŸ
                </button>
            </div>
            <ul class="list-group" id="dateList"></ul>
        </div>
    `;
    adminSection.prepend(card);

    const newDateInput = card.querySelector('#newDateInput');
    const dateList = card.querySelector('#dateList');
    const addDateBtn = card.querySelector('#addDateBtn');

    function refreshDateList() {
        dateList.innerHTML = '';
        availableDates.sort();
        availableDates.forEach((date, idx) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                <span>${date}</span>
                <button class="btn btn-sm btn-danger" data-index="${idx}">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            dateList.appendChild(li);
        });
    }

    addDateBtn.addEventListener('click', () => {
        const newDate = newDateInput.value;
        if (!newDate) {
            alert('è«‹é¸æ“‡æœ‰æ•ˆçš„æ—¥æœŸ');
            return;
        }
        if (availableDates.includes(newDate)) {
            alert('æ­¤æ—¥æœŸå·²å­˜åœ¨');
            return;
        }
        availableDates.push(newDate);
        initDateOptions();
        refreshDateList();
        newDateInput.value = '';
    });

    dateList.addEventListener('click', (e) => {
        if (e.target.closest('button')) {
            const idx = e.target.closest('button').dataset.index;
            const dateToDelete = availableDates[idx];
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${dateToDelete}ã€é€™å€‹æ—¥æœŸå—ï¼Ÿ`)) {
                availableDates.splice(idx, 1);
                initDateOptions();
                refreshDateList();
            }
        }
    });

    refreshDateList();
}

// åˆå§‹åŒ–ç®¡ç†å“¡åŠŸèƒ½
window.addEventListener('DOMContentLoaded', () => {
    initDateOptions();
    renderDateManagement();
});

        // æª¢æŸ¥å­¸è™Ÿæ˜¯å¦å­˜åœ¨
        async function checkStudentId(studentId) {
            try {
                elements.studentInfoDiv.innerHTML = '<div class="text-muted"><span class="loading-spinner"></span> æŸ¥è©¢ä¸­...</div>';
                
                const docRef = db.collection('å—å±±å­¸ç”Ÿè³‡æ–™').doc(studentId);
                const doc = await docRef.get();
                
                if (!doc.exists) {
                    elements.studentInfoDiv.innerHTML = '<div class="alert alert-danger">æ‰¾ä¸åˆ°æ­¤å­¸è™Ÿçš„å­¸ç”Ÿè³‡æ–™</div>';
                    currentStudent = null;
                    return false;
                }
                
                const data = doc.data();
                currentStudent = {
                    id: studentId,
                    name: data['å§“å'] || 'æœªæä¾›',
                    grade: data['å¹´ç´š'] || 'æœªæä¾›',
                    class: data['ç­ç´š'] || 'æœªæä¾›'
                };
                
                elements.studentInfoDiv.innerHTML = `
                    <div class="alert alert-success">
                        <strong>å§“å:</strong> ${currentStudent.name}<br>
                        <strong>ç­ç´š:</strong> ${currentStudent.grade}${currentStudent.class}
                    </div>
                `;
                
                return true;
            } catch (error) {
                console.error("æŸ¥è©¢å­¸ç”Ÿè³‡æ–™éŒ¯èª¤:", error);
                let errorMessage = 'æŸ¥è©¢å­¸ç”Ÿè³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤';
                
                if (error.code === 'permission-denied') {
                    errorMessage = 'æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•æŸ¥è©¢å­¸ç”Ÿè³‡æ–™';
                }
                
                elements.studentInfoDiv.innerHTML = `
                    <div class="alert alert-danger">
                        ${errorMessage}
                        <div class="error-details">éŒ¯èª¤ä»£ç¢¼: ${error.code || 'æœªçŸ¥'}</div>
                    </div>
                `;
                return false;
            }
        }

        // æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦å·²åœ¨åŒä¸€å¤©å ±å
        async function checkDuplicateRegistration(studentId, date) {
            try {
                const snapshot = await db.collection('å ±åè¨˜éŒ„')
                    .where('å­¸è™Ÿ', '==', studentId)
                    .where('å¯¦æ–½æ—¥æœŸ', '==', date)
                    .get();
                
                if (!snapshot.empty) {
                    return true; // å·²å ±åé
                }
                return false; // æœªå ±åé
            } catch (error) {
                console.error("æª¢æŸ¥é‡è¤‡å ±åéŒ¯èª¤:", error);
                return false;
            }
        }

        // æª¢æŸ¥æ—¥æœŸå ±åäººæ•¸
        async function checkDateAvailability(date) {
            try {
                const snapshot = await db.collection('å ±åè¨˜éŒ„')
                    .where('å¯¦æ–½æ—¥æœŸ', '==', date)
                    .get();
                
                const count = snapshot.size;
                const remaining = 50 - count;
                
                elements.dateInfoDiv.textContent = `å·²å ±å: ${count}äºº / å‰©é¤˜åé¡: ${remaining}äºº`;
                
                if (count >= 50) {
                    elements.dateInfoDiv.innerHTML += '<br><span class="text-danger">æ­¤æ—¥æœŸå·²é¡æ»¿ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ</span>';
                    return false;
                }
                
                return true;
            } catch (error) {
                console.error("æª¢æŸ¥æ—¥æœŸå¯ç”¨æ€§éŒ¯èª¤:", error);
                elements.dateInfoDiv.innerHTML = `
                    <div class="text-danger">
                        ç„¡æ³•å–å¾—å ±åè³‡æ–™
                        <div class="error-details">${error.message || 'æœªçŸ¥éŒ¯èª¤'}</div>
                    </div>
                `;
                return false;
            }
        }

        // æŸ¥è©¢ç‰¹å®šæ—¥æœŸçš„å ±åè¨˜éŒ„ (æ–°å¢å­¸è™ŸæŸ¥è©¢åŠŸèƒ½)
        // æŸ¥è©¢ç‰¹å®šæ—¥æœŸçš„å ±åè¨˜éŒ„ (æ–°å¢å­¸è™ŸæŸ¥è©¢åŠŸèƒ½)
// æŸ¥è©¢ç‰¹å®šæ—¥æœŸçš„å ±åè¨˜éŒ„ (æ–°å¢å­¸è™ŸæŸ¥è©¢åŠŸèƒ½)
async function queryRegistrations(date, studentId = '') {
    try {
        elements.queryResults.innerHTML = '<div class="text-center"><span class="loading-spinner"></span> æŸ¥è©¢ä¸­...</div>';
        elements.printListBtn.style.display = 'none';

        let formattedDate = '';
        if (date && !isNaN(new Date(date))) {
            formattedDate = new Date(date).toISOString().split('T')[0];
        } else if (date) {
            throw new RangeError("Invalid time value");
        }

        let query = db.collection('å ±åè¨˜éŒ„').orderBy('å ±åæ™‚é–“');

        // å¦‚æœæœ‰æŒ‡å®šæ—¥æœŸï¼Œæ·»åŠ æ—¥æœŸæ¢ä»¶
        if (formattedDate) {
            query = query.where('å¯¦æ–½æ—¥æœŸ', '==', formattedDate);
        }

        // å¦‚æœæœ‰æŒ‡å®šå­¸è™Ÿï¼Œæ·»åŠ å­¸è™Ÿæ¢ä»¶
        if (studentId) {
            query = query.where('å­¸è™Ÿ', '==', studentId);
        }

        const snapshot = await query.get();

        if (snapshot.empty) {
            elements.queryResults.innerHTML = '<div class="alert alert-info">æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„å ±åè¨˜éŒ„</div>';
            queryResultData = [];
            return;
        }

        queryResultData = [];
        let html = `
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>åºè™Ÿ</th>
                            <th>å­¸è™Ÿ</th>
                            <th>å§“å</th>
                            <th>ç­ç´š</th>
                            <th>å¯¦æ–½æ—¥æœŸ</th>
                            <th>æ™‚æ•¸</th>
                            <th>é¡åˆ¥</th>
                            <th>å ±åæ™‚é–“</th><th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        let index = 1;
        snapshot.forEach(doc => {
            const data = doc.data();
            const registrationTime = data.å ±åæ™‚é–“ && data.å ±åæ™‚é–“.seconds ?
                new Date(data.å ±åæ™‚é–“.seconds * 1000).toLocaleString('zh-TW') :
                'æœªè¨˜éŒ„';

            queryResultData.push({
                id: data.å­¸è™Ÿ || 'æœªæä¾›',
                name: data.å§“å || 'æœªæä¾›',
                class: data.ç­ç´š || 'æœªæä¾›',
                date: data.å¯¦æ–½æ—¥æœŸ || 'æœªæä¾›',
                hours: data.å¯¦æ–½æ™‚æ•¸ || 'æœªæä¾›',
                type: data.é¡åˆ¥ || 'æœªæä¾›',
                time: registrationTime
            });

            html += `
                <tr>
                    <td>${index}</td>
                    <td>${data.å­¸è™Ÿ || 'æœªæä¾›'}</td>
                    <td>${data.å§“å || 'æœªæä¾›'}</td>
                    <td>${data.ç­ç´š || 'æœªæä¾›'}</td>
                    <td>${data.å¯¦æ–½æ—¥æœŸ || 'æœªæä¾›'}</td>
                    <td>${data.å¯¦æ–½æ™‚æ•¸ || '0'}å°æ™‚</td>
                    <td>${data.é¡åˆ¥ || 'æœªæŒ‡å®š'}</td>
                    <td>${registrationTime}</td>
<td><button class="btn btn-sm btn-danger" onclick="deleteRegistration('${doc.id}')">åˆªé™¤</button></td>
</tr>
            `;
            index++;
        });

        html += `
                    </tbody>
                </table>
                <div class="alert alert-info mt-3">
                    å…±æ‰¾åˆ° ${snapshot.size} ç­†å ±åè¨˜éŒ„
                </div>
            </div>
        `;

        elements.queryResults.innerHTML = html;
        elements.printListBtn.style.display = 'inline-block';

    } catch (error) {
        console.error("æŸ¥è©¢å ±åè¨˜éŒ„éŒ¯èª¤:", error);
        let errorMessage = 'æŸ¥è©¢å ±åè¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤';

        if (error instanceof RangeError) {
            errorMessage = 'æŸ¥è©¢æ—¥æœŸæ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹é‡æ–°é¸æ“‡';
        } else if (error.code === 'permission-denied') {
            errorMessage = 'æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•æŸ¥è©¢å ±åè¨˜éŒ„';
        } else if (error.code === 'invalid-argument') {
            errorMessage = 'æŸ¥è©¢æ¢ä»¶ç„¡æ•ˆï¼Œè«‹æª¢æŸ¥æ—¥æœŸæ ¼å¼';
        }

        elements.queryResults.innerHTML = `
            <div class="alert alert-danger">
                ${errorMessage}
                <div class="error-details">éŒ¯èª¤è¨Šæ¯: ${error.message || 'æœªçŸ¥'}</div>
            </div>
        `;
        queryResultData = [];
        elements.printListBtn.style.display = 'none';
    }
}



        // é¡¯ç¤ºé è¦½
        async function showPreview() {
            const activityDate = elements.activityDateSelect.value;
            const activityHours = document.getElementById('activityHours').value;
            const activityType = document.getElementById('activityType').value;
            
            // æª¢æŸ¥æ˜¯å¦å·²å ±åéåŒä¸€å¤©
            const isDuplicate = await checkDuplicateRegistration(currentStudent.id, activityDate);
            if (isDuplicate) {
                alert('æ‚¨å·²ç¶“å ±åéæ­¤æ—¥æœŸçš„æ´»å‹•ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ');
                return;
            }
            
            registrationData = {
                studentId: currentStudent.id,
                studentName: currentStudent.name,
                studentClass: `${currentStudent.grade}${currentStudent.class}`,
                activityDate: activityDate,
                activityHours: activityHours,
                activityType: activityType,
                registrationTime: new Date().toLocaleString('zh-TW')
            };
            
            elements.previewContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>å­¸è™Ÿ:</strong> ${currentStudent.id}</p>
                        <p><strong>å§“å:</strong> ${currentStudent.name}</p>
                        <p><strong>ç­ç´š:</strong> ${currentStudent.grade}${currentStudent.class}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>å¯¦æ–½æ—¥æœŸ:</strong> ${activityDate}</p>
                        <p><strong>å¯¦æ–½æ™‚æ•¸:</strong> ${activityHours}å°æ™‚</p>
                        <p><strong>é¡åˆ¥:</strong> ${activityType}</p>
                    </div>
                </div>
                <div class="alert alert-info mt-3">
                    è«‹ç¢ºèªä»¥ä¸Šè³‡æ–™ç„¡èª¤å¾Œå†æäº¤ï¼Œæäº¤å¾Œå°‡ç„¡æ³•ä¿®æ”¹ã€‚
                </div>
            `;
            
            elements.previewSection.style.display = 'block';
            window.scrollTo({ top: elements.previewSection.offsetTop, behavior: 'smooth' });
        }

        // æº–å‚™åˆ—å°åå–®å…§å®¹
        function preparePrintListContent() {
            if (queryResultData.length === 0) {
                alert('æ²’æœ‰å¯åˆ—å°çš„è³‡æ–™ï¼Œè«‹å…ˆæŸ¥è©¢å ±åè¨˜éŒ„');
                return false;
            }
            
            elements.printListDate.textContent = elements.queryDate.value || 'æ‰€æœ‰æ—¥æœŸ';
            elements.printListTime.textContent = new Date().toLocaleString('zh-TW');
            elements.printListBody.innerHTML = '';
            
            queryResultData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.id || 'æœªæä¾›'}</td>
                    <td>${item.name || 'æœªæä¾›'}</td>
                    <td>${item.class || 'æœªæä¾›'}</td>
                    <td>${item.hours || '0'}å°æ™‚</td>
                    <td>${item.type || 'æœªæŒ‡å®š'}</td>
                    <td>${item.time || 'æœªè¨˜éŒ„'}</td>
                `;
                elements.printListBody.appendChild(row);
            });
            
            elements.printTotalCount.textContent = queryResultData.length;
            return true;
        }

        // åˆ—å°å ±ååå–®
        function printRegistrationList() {
            if (!preparePrintListContent()) return;
            
            // æ·»åŠ åˆ—å°é¡åˆ¥åˆ°body
            document.body.classList.add('print-list');
            
            // ç¢ºä¿å…§å®¹å¯è¦‹
            elements.printListContent.style.display = 'block';
            
            // æ·»åŠ çŸ­æš«å»¶é²ç¢ºä¿å…§å®¹å·²æ¸²æŸ“
            setTimeout(() => {
                window.print();
                
                // åˆ—å°å®Œæˆå¾Œæ¢å¾©ç‹€æ…‹
                setTimeout(() => {
                    document.body.classList.remove('print-list');
                    elements.printListContent.style.display = 'none';
                }, 500);
            }, 100);
        }

        // æäº¤å ±åè³‡æ–™
        async function submitRegistration() {
            const activityDate = elements.activityDateSelect.value;
            const activityHours = document.getElementById('activityHours').value;
            const activityType = document.getElementById('activityType').value;
            
            // æª¢æŸ¥æ—¥æœŸæ˜¯å¦å¯ç”¨
            const isAvailable = await checkDateAvailability(activityDate);
            if (!isAvailable) {
                alert('æ­¤æ—¥æœŸå·²é¡æ»¿ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ');
                return;
            }
            
            // å†æ¬¡æª¢æŸ¥æ˜¯å¦å·²å ±åéåŒä¸€å¤©
            const isDuplicate = await checkDuplicateRegistration(currentStudent.id, activityDate);
            if (isDuplicate) {
                alert('æ‚¨å·²ç¶“å ±åéæ­¤æ—¥æœŸçš„æ´»å‹•ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ');
                return;
            }
            
            try {
                elements.confirmBtn.innerHTML = '<span class="loading-spinner"></span> æäº¤ä¸­...';
                elements.confirmBtn.disabled = true;
                
                const now = new Date();
                const registrationTime = firebase.firestore.Timestamp.fromDate(now);
                
                await db.collection('å ±åè¨˜éŒ„').add({
                    å­¸è™Ÿ: currentStudent.id,
                    ç­ç´š: `${currentStudent.grade}${currentStudent.class}`,
                    å§“å: currentStudent.name,
                    å¯¦æ–½æ—¥æœŸ: activityDate,
                    å¯¦æ–½æ™‚æ•¸: parseInt(activityHours),
                    é¡åˆ¥: activityType,
                    å ±åæ™‚é–“: registrationTime,
                    ç‹€æ…‹: 'å·²å ±å'
                });
                
                elements.confirmBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> ç¢ºèªæäº¤';
                elements.confirmBtn.disabled = false;
                
                const successAlert = document.createElement('div');
                successAlert.className = 'alert alert-success alert-dismissible fade show';
                successAlert.innerHTML = `
                    <strong>å ±åæˆåŠŸï¼</strong> æ‚¨çš„å‡æ—¥éŠ·éå·²æˆåŠŸå ±åã€‚
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.querySelector('.container').prepend(successAlert);
                
                registrationData = {
                    studentId: currentStudent.id,
                    studentName: currentStudent.name,
                    studentClass: `${currentStudent.grade}${currentStudent.class}`,
                    activityDate: activityDate,
                    activityHours: activityHours,
                    activityType: activityType,
                    registrationTime: now.toLocaleString('zh-TW')
                };
                
                resetForm();
            } catch (error) {
                console.error("æäº¤å ±åéŒ¯èª¤:", error);
                elements.confirmBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> ç¢ºèªæäº¤';
                elements.confirmBtn.disabled = false;
                
                let errorMessage = 'å ±åå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
                if (error.code === 'permission-denied') {
                    errorMessage = 'æ¬Šé™ä¸è¶³ï¼Œç„¡æ³•æäº¤å ±å';
                }
                
                alert(errorMessage);
            }
        }

        // é‡ç½®è¡¨å–®
        function resetForm() {
            document.getElementById('registrationForm').reset();
            elements.studentInfoDiv.innerHTML = '';
            elements.dateInfoDiv.textContent = '';
            elements.previewSection.style.display = 'none';
            currentStudent = null;
        }

        // äº‹ä»¶ç›£è½å™¨
        elements.studentIdInput.addEventListener('blur', async () => {
            if (elements.studentIdInput.value.trim() !== '') {
                await checkStudentId(elements.studentIdInput.value.trim());
            }
        });

        elements.activityDateSelect.addEventListener('change', async () => {
            if (elements.activityDateSelect.value !== '') {
                await checkDateAvailability(elements.activityDateSelect.value);
            } else {
                elements.dateInfoDiv.textContent = '';
            }
        });

        elements.previewBtn.addEventListener('click', async () => {
            if (!currentStudent) {
                alert('è«‹å…ˆè¼¸å…¥æœ‰æ•ˆçš„å­¸è™Ÿ');
                return;
            }
            
            const activityDate = elements.activityDateSelect.value;
            const activityHours = document.getElementById('activityHours').value;
            const activityType = document.getElementById('activityType').value;
            
            if (!activityDate || !activityHours || !activityType) {
                alert('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½');
                return;
            }
            
            const isAvailable = await checkDateAvailability(activityDate);
            if (!isAvailable) {
                alert('æ­¤æ—¥æœŸå·²é¡æ»¿ï¼Œè«‹é¸æ“‡å…¶ä»–æ—¥æœŸ');
                return;
            }
            
            showPreview();
        });

        elements.confirmBtn.addEventListener('click', submitRegistration);
        elements.editBtn.addEventListener('click', () => {
            elements.previewSection.style.display = 'none';
        });
        elements.queryBtn.addEventListener('click', () => {
            const studentId = elements.queryStudentId.value.trim();
            const date = elements.queryDate.value;
            
            if (!date && !studentId) {
                alert('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æŸ¥è©¢æ¢ä»¶ï¼ˆå­¸è™Ÿæˆ–æ—¥æœŸï¼‰');
                return;
            }
            
            queryRegistrations(date, studentId);
        });
        elements.printListBtn.addEventListener('click', printRegistrationList);

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initDateOptions();
        });
    


async function deleteRegistration(docId) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å ±åè³‡æ–™å—ï¼Ÿ')) return;
    try {
        await db.collection('å ±åè¨˜éŒ„').doc(docId).delete();
        alert('åˆªé™¤æˆåŠŸ');
        const studentId = elements.queryStudentId.value.trim();
        const date = elements.queryDate.value;
        queryRegistrations(date, studentId);  // é‡æ–°æŸ¥è©¢åˆ·æ–°çµæœ
    } catch (error) {
        console.error("åˆªé™¤å¤±æ•—", error);
        alert("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
}
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const tabs = document.querySelectorAll("#mainTabs .nav-link");
    tabs.forEach(tab => {
        tab.addEventListener("click", function () {
            tabs.forEach(t => t.classList.remove("active"));
            document.querySelectorAll(".tab-main").forEach(sec => sec.style.display = "none");
            this.classList.add("active");
            const target = this.getAttribute("data-target");
            const section = document.querySelector(target);
            if (section) section.style.display = "";
        });
    });
});
</script>

<div aria-hidden="true" aria-labelledby="loginModalLabel" class="modal fade" id="loginModal" tabindex="-1">
<div class="modal-dialog">
<div class="modal-content">
<div class="modal-header bg-dark text-white">
<h5 class="modal-title" id="loginModalLabel">ç®¡ç†å“¡ç™»å…¥</h5>
<button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
</div>
<div class="modal-body">
<div class="mb-3">
<label class="form-label" for="adminUsername">å¸³è™Ÿ</label>
<input class="form-control" id="adminUsername" placeholder="è¼¸å…¥ç®¡ç†å“¡å¸³è™Ÿ" type="text"/>
</div>
<div class="mb-3">
<label class="form-label" for="adminPassword">å¯†ç¢¼</label>
<input class="form-control" id="adminPassword" placeholder="è¼¸å…¥å¯†ç¢¼" type="password"/>
</div>
<div class="text-danger" id="loginError" style="display: none;">å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" data-bs-dismiss="modal" type="button">å–æ¶ˆ</button>
<button class="btn btn-primary" onclick="validateLogin()" type="button">ç™»å…¥</button>
</div>
</div>
</div>
</div>
<script>
function showLoginModal() {
    const modal = new bootstrap.Modal(document.getElementById('loginModal'));
    modal.show();
}
function validateLogin() {
    const username = document.getElementById('adminUsername').value.trim();
    const password = document.getElementById('adminPassword').value.trim();
    const errorDiv = document.getElementById('loginError');
    if (username === 'admin' && password === '1234') {
        const modal = bootstrap.Modal.getInstance(document.getElementById('loginModal'));
        modal.hide();
        sessionStorage.setItem('adminLoggedIn', 'true');
        document.querySelector('#tabAdmin').style.display = '';
        document.querySelector('#tabStudent').style.display = 'none';
        document.querySelectorAll('#mainTabs .nav-link').forEach(el => el.classList.remove('active'));
        document.querySelector('#mainTabs .nav-link[data-target="#tabAdmin"]').classList.add('active');
    } else {
        errorDiv.style.display = 'block';
    }
}

document.addEventListener("DOMContentLoaded", function () {
    const tabs = document.querySelectorAll("#mainTabs .nav-link");
    tabs.forEach(tab => {
        tab.addEventListener("click", function (e) {
            const target = this.getAttribute("data-target");
            if (target === "#tabAdmin" && sessionStorage.getItem('adminLoggedIn') !== 'true') {
                e.preventDefault();
                showLoginModal();
                return;
            }
            tabs.forEach(t => t.classList.remove("active"));
            document.querySelectorAll(".tab-main").forEach(sec => sec.style.display = "none");
            this.classList.add("active");
            const section = document.querySelector(target);
            if (section) section.style.display = "";
        });
    });
});
</script><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script>
function logout() {
    sessionStorage.removeItem('adminLoggedIn');
    document.querySelector('#tabAdmin').style.display = 'none';
    document.querySelector('#tabStudent').style.display = '';
    document.querySelectorAll('#mainTabs .nav-link').forEach(el => el.classList.remove('active'));
    document.querySelector('#mainTabs .nav-link[data-target="#tabStudent"]').classList.add('active');
    document.getElementById('logoutTab').style.display = 'none';
}

// è‡ªå‹•é€¾æ™‚ç™»å‡ºï¼š30 ç§’
let logoutTimeout = setTimeout(logout, 30 * 1000);
['click', 'mousemove', 'keypress', 'scroll'].forEach(evt => {
    document.addEventListener(evt, () => {
        clearTimeout(logoutTimeout);
        logoutTimeout = setTimeout(logout, 30 * 1000);
    });
});

// ç™»å…¥å¾Œé¡¯ç¤ºç™»å‡ºæŒ‰éˆ•
document.addEventListener("DOMContentLoaded", () => {
    if (sessionStorage.getItem('adminLoggedIn') === 'true') {
        document.getElementById('logoutTab').style.display = 'block';
    }
});
</script></body></html>
